{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header text-white" style="background: linear-gradient(45deg, var(--indigo-400), var(--indigo-500));">
                    <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Generate Monthly Bill</h5>
                </div>
                <div class="card-body" style="background: linear-gradient(135deg, var(--indigo-50), var(--slate-50));">
                    <form method="POST" id="generateBillForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="student_id" class="form-label">Select Student</label>
                                    <select class="form-select" name="student_id" id="student_id" required>
                                        <option value="">Choose student...</option>
                                        {% for student in students %}
                                        <option value="{{ student.id }}" {% if request.args.get('student_id')|int == student.id %}selected{% endif %}>{{ student.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Please select a student.</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="month" class="form-label">Month</label>
                                    <select class="form-select" name="month" id="month" required>
                                        {% set months = [
                                            'January', 'February', 'March', 'April', 'May', 'June',
                                            'July', 'August', 'September', 'October', 'November', 'December'
                                        ] %}
                                        {% for i in range(12) %}
                                        <option value="{{ i + 1 }}" {% if i + 1 == current_month %}selected{% endif %}>
                                            {{ months[i] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Please select a month.</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="year" class="form-label">Year</label>
                                    <input type="number" class="form-control" name="year" id="year"
                                           value="{{ current_year }}" min="2020" max="2030" required>
                                    <div class="invalid-feedback">Please enter a valid year (2020-2030).</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn position-relative text-white" id="generateBillBtn" 
                        style="background: linear-gradient(45deg, #fb923c, #f97316);">
                                    <i class="fas fa-file-invoice me-2"></i>Generate Bill
                                    <span class="d-none spinner-border spinner-border-sm position-absolute" 
                                          id="generateSpinner" 
                                          style="right: 8px; top: 50%; transform: translateY(-50%);"></span>
                                </button>
                            </div>
                        </div>
                    </form>
                    <!-- Error Alert -->
                    <div class="alert alert-danger mt-3 d-none" id="errorAlert" role="alert"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header text-white" style="background: linear-gradient(45deg, #fdba74, #fb923c);">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Summary</h5>
                </div>
                <div class="card-body" style="background-color: #ffedd5;">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Total Bills</strong>
                                <div class="small text-muted">₹{{ "%.2f"|format(total_amount or 0) }}</div>
                            </div>
                            <span class="badge rounded-pill" style="background: linear-gradient(45deg, #fb923c, #f97316);">{{ bills|length }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Pending Bills</strong>
                                <div class="small text-muted">₹{{ "%.2f"|format(pending_amount or 0) }}</div>
                            </div>
                            <span class="badge rounded-pill" style="background: linear-gradient(45deg, #fdba74, #fb923c);">{{ bills|selectattr('paid', 'eq', false)|list|length }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Paid Bills</strong>
                                <div class="small text-muted">₹{{ "%.2f"|format(paid_amount or 0) }}</div>
                            </div>
                            <span class="badge rounded-pill" style="background: linear-gradient(45deg, #f97316, #ea580c);">{{ bills|selectattr('paid', 'eq', true)|list|length }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header text-white" style="background: linear-gradient(45deg, #f97316, #ea580c);">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Bill History</h5>
                <div>
                    <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#filterSection">
                        <i class="fas fa-filter me-1"></i>Filters
                    </button>
                </div>
            </div>
        </div>
        <div class="collapse" id="filterSection">
            <div class="card-body" style="background-color: #fff7ed;">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Student</label>
                        <select class="form-select" id="filterStudentId">
                            <option value="">All Students</option>
                            {% for student in students %}
                            <option value="{{ student.id }}">{{ student.name }} ({{ student.roll_no }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">All</option>
                            <option value="paid">Paid</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="filterDate">
                            <option value="">All Time</option>
                            <option value="current">Current Month</option>
                            <option value="last3">Last 3 Months</option>
                            <option value="last6">Last 6 Months</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-secondary w-100" onclick="applyFilters()">
                            Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="billsTable">
                    <thead>
                        <tr>
                            <th>Bill ID</th>
                            <th>Student</th>
                            <th>Month/Year</th>
                            <th>Amount</th>
                            <th>Days Present</th>
                            <th>Generated On</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in bills %}
                        <tr data-student-id="{{ bill.student.id }}">
                            <td>{{ bill.id }}</td>
                            <td>{{ bill.student.name }}</td>
                            <td>{{ bill.month }}/{{ bill.year }}</td>
                            <td>₹{{ "%.2f"|format(bill.amount) }}</td>
                            <td>{{ bill.days_present }}</td>
                            <td>{{ bill.generated_on.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if bill.paid %}
                                <span class="badge" style="background: linear-gradient(45deg, #f97316, #ea580c);">Paid</span>
                                {% else %}
                                <span class="badge" style="background: linear-gradient(45deg, #fdba74, #fb923c);">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-info" 
                                            data-bill-id="{{ bill.id }}"
                                            onclick="viewBill(this.getAttribute('data-bill-id'))"
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning" 
                                            data-bill-id="{{ bill.id }}"
                                            onclick="managePayments(this.getAttribute('data-bill-id'))"
                                            title="Manage Payments">
                                        <i class="fas fa-wallet"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success" 
                                            data-bill-id="{{ bill.id }}"
                                            onclick="markAsPaid(this.getAttribute('data-bill-id'))"
                                            title="Mark as Paid"
                                            {% if bill.paid %}disabled{% endif %}>
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            data-bill-id="{{ bill.id }}"
                                            onclick="deleteBill(this.getAttribute('data-bill-id'))"
                                            title="Delete Bill">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View Bill Modal -->
<div class="modal fade" id="viewBillModal" tabindex="-1" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bill Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="billDetails">
                <!-- Bill details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="printBill()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Payments Modal -->
<div class="modal fade" id="managePaymentsModal" tabindex="-1" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-wallet me-2 text-warning"></i>Bill Payments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="adminPaymentFeedback" class="alert d-none" role="alert"></div>
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <div class="small text-muted">
                        Review submitted payments. Verify valid transactions to mark the bill as paid or reject incorrect submissions.
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" id="recordOfflinePaymentBtn" onclick="recordOfflinePayment()">
                        <i class="fas fa-clipboard-check me-1"></i>Record Offline Payment
                    </button>
                </div>
                <div id="adminPaymentList" class="list-group list-group-flush border rounded"></div>
                <div id="adminPaymentEmpty" class="text-center text-muted py-4 d-none">
                    <i class="fas fa-receipt fa-3x mb-3"></i>
                    <p class="mb-0">No payment submissions yet for this bill.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Form validation and submission
const form = document.getElementById('generateBillForm');
const errorAlert = document.getElementById('errorAlert');
const generateBtn = document.getElementById('generateBillBtn');
const spinner = document.getElementById('generateSpinner');

function showError(message) {
    errorAlert.textContent = message;
    errorAlert.classList.remove('d-none');
    setTimeout(() => {
        errorAlert.classList.add('d-none');
    }, 5000);
}

function showLoading(isLoading) {
    if (isLoading) {
        generateBtn.disabled = true;
        spinner.classList.remove('d-none');
    } else {
        generateBtn.disabled = false;
        spinner.classList.add('d-none');
    }
}

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    errorAlert.classList.add('d-none');
    showLoading(true);
    
    try {
        const formData = new FormData(this);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch('/generate-bill', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData,
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Show success message before reloading
            const alert = document.createElement('div');
            alert.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
            alert.style.zIndex = '9999';
            alert.textContent = data.message;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showError(data.message || 'Failed to generate bill. Please try again.');
        }
    } catch (error) {
        showError('An error occurred. Please try again.');
    } finally {
        showLoading(false);
    }
});

// Filters
function applyFilters() {
    const studentFilterId = document.getElementById('filterStudentId').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const dateFilter = document.getElementById('filterDate').value;
    let visibleCount = 0;
    
    const rows = document.querySelectorAll('#billsTable tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // Student filter by id
        if (studentFilterId) {
            const rowStudentId = row.getAttribute('data-student-id');
            if (rowStudentId !== studentFilterId) show = false;
        }
        
        // Status filter
        if (statusFilter) {
            const status = row.cells[6].textContent.trim().toLowerCase();
            if (statusFilter === 'paid' && status !== 'paid') show = false;
            if (statusFilter === 'pending' && status !== 'pending') show = false;
        }
        
        // Date filter
        if (dateFilter) {
            const billDate = new Date(row.cells[5].textContent);
            const today = new Date();
            
            if (dateFilter === 'current' && billDate.getMonth() !== today.getMonth()) {
                show = false;
            } else if (dateFilter === 'last3') {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(today.getMonth() - 3);
                if (billDate < threeMonthsAgo) show = false;
            } else if (dateFilter === 'last6') {
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(today.getMonth() - 6);
                if (billDate < sixMonthsAgo) show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Show no results message if needed
    const noResults = document.getElementById('noResults');
    if (visibleCount === 0) {
        if (!noResults) {
            const tbody = document.querySelector('#billsTable tbody');
            const tr = document.createElement('tr');
            tr.id = 'noResults';
            tr.innerHTML = `
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-search mb-2 fs-3"></i>
                    <p class="mb-0">No bills found matching your filters</p>
                </td>
            `;
            tbody.appendChild(tr);
        }
    } else if (noResults) {
        noResults.remove();
    }
}

// Bill viewing
async function viewBill(billId) {
    const modal = new bootstrap.Modal(document.getElementById('viewBillModal'), { backdrop: false, keyboard: true });
    const billDetails = document.getElementById('billDetails');
    
    // Show loading state
    billDetails.innerHTML = '<div class="text-center py-5"><div class="spinner-border" role="status"></div></div>';
    modal.show();
    
    try {
        const response = await fetch(`/bill/${billId}`);
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to load bill details');
        const paymentStatusMap = {
            submitted: { badge: 'bg-warning text-dark', label: 'Pending Verification', icon: 'fa-hourglass-half' },
            verified: { badge: 'bg-success', label: 'Verified', icon: 'fa-check-circle' },
            rejected: { badge: 'bg-danger', label: 'Rejected', icon: 'fa-times-circle' }
        };
        
        billDetails.innerHTML = `
            <div class="bill-preview">
                <div class="text-center mb-4">
                    <h3>Mess Bill</h3>
                    <p class="mb-0">Bill #${data.id}</p>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="text-primary">Student Details</h5>
                        <p class="mb-1"><strong>Name:</strong> ${data.student.name}</p>
                        <p class="mb-1"><strong>Contact:</strong> ${data.student.contact}</p>
                        <p class="mb-1"><strong>Email:</strong> ${data.student.email}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <h5 class="text-primary">Bill Details</h5>
                        <p class="mb-1"><strong>Month/Year:</strong> ${data.month_name} ${data.year}</p>
                        <p class="mb-1"><strong>Generated On:</strong> ${new Date(data.generated_on).toLocaleDateString()}</p>
                        <p class="mb-1"><strong>Status:</strong> 
                            <span class="badge ${data.paid ? 'bg-success' : 'bg-warning'}">
                                ${data.paid ? 'Paid' : 'Pending'}
                            </span>
                        </p>
                    </div>
                </div>
                <div class="table-responsive mb-4">
                    <table class="table table-bordered">
                        <tr>
                            <th class="bg-light">Days Present</th>
                            <td>${data.days_present}</td>
                            <th class="bg-light">Daily Rate</th>
                            <td>₹${data.daily_rate.toFixed(2)}</td>
                        </tr>
                        <tr class="table-primary">
                            <th colspan="3" class="text-end">Total Amount</th>
                            <td><strong>₹${data.amount.toFixed(2)}</strong></td>
                        </tr>
                    </table>
                </div>
                <div class="mt-4">
                    <h6 class="fw-bold mb-2"><i class="fas fa-wallet me-2 text-warning"></i>Payments</h6>
                    ${data.payments.length ? `
                    <div class="list-group list-group-flush">
                        ${data.payments.map(payment => {
                            const status = paymentStatusMap[payment.status] || paymentStatusMap.submitted;
                            const createdAt = payment.created_at ? new Date(payment.created_at).toLocaleString() : 'N/A';
                            const verifiedAt = payment.verified_at ? new Date(payment.verified_at).toLocaleString() : null;
                            return `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between flex-wrap gap-2">
                                        <div>
                                            <div class="fw-semibold">₹${payment.amount.toFixed(2)} · ${(payment.method || 'upi').toUpperCase()}</div>
                                            <div class="small text-muted">Reference: ${payment.reference || 'N/A'}</div>
                                            <div class="small text-muted">Submitted: ${createdAt}</div>
                                            ${payment.notes ? `<div class="small text-muted">Notes: ${payment.notes}</div>` : ''}
                                            ${verifiedAt ? `<div class="small text-muted">Verified: ${verifiedAt} by ${payment.verified_by || 'Admin'}</div>` : ''}
                                        </div>
                                        <span class="badge ${status.badge} align-self-center"><i class="fas ${status.icon} me-1"></i>${status.label}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>` : '<div class="text-muted">No payments recorded yet.</div>'}
                </div>
            </div>
        `;
    } catch (error) {
        billDetails.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                ${error.message || 'Failed to load bill details. Please try again.'}
            </div>
        `;
    }
}

// Manage payments modal
let managePaymentsModal;
let activeBillForPayments = null;

function ensureManagePaymentsModal() {
    if (!managePaymentsModal) {
        const modalElement = document.getElementById('managePaymentsModal');
        managePaymentsModal = new bootstrap.Modal(modalElement, { backdrop: false, keyboard: true });
        modalElement.addEventListener('hidden.bs.modal', () => {
            activeBillForPayments = null;
            document.getElementById('adminPaymentList').innerHTML = '';
            document.getElementById('adminPaymentEmpty').classList.add('d-none');
            hideAdminPaymentFeedback();
        });
    }
}

function showAdminPaymentFeedback(message, type = 'info') {
    const feedback = document.getElementById('adminPaymentFeedback');
    feedback.textContent = message;
    feedback.className = `alert alert-${type}`;
    feedback.classList.remove('d-none');
}

function hideAdminPaymentFeedback() {
    document.getElementById('adminPaymentFeedback').classList.add('d-none');
}

async function managePayments(billId) {
    ensureManagePaymentsModal();
    activeBillForPayments = billId;
    managePaymentsModal.show();
    document.getElementById('adminPaymentList').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"></div></div>';
    document.getElementById('adminPaymentEmpty').classList.add('d-none');
    await loadAdminPayments(billId);
}

async function loadAdminPayments(billId) {
    try {
        const response = await fetch(`/bill/${billId}/payments`, { credentials: 'same-origin' });
        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Failed to load payments');
        }
        renderAdminPayments(data.payments, data.bill);
    } catch (error) {
        document.getElementById('adminPaymentList').innerHTML = '';
        document.getElementById('adminPaymentEmpty').classList.remove('d-none');
        showAdminPaymentFeedback(error.message || 'Unable to load payments.', 'danger');
    }
}

function renderAdminPayments(payments, bill) {
    const list = document.getElementById('adminPaymentList');
    const emptyState = document.getElementById('adminPaymentEmpty');
    const offlineBtn = document.getElementById('recordOfflinePaymentBtn');

    if (bill.paid) {
        offlineBtn.classList.add('d-none');
    } else {
        offlineBtn.classList.remove('d-none');
    }

    if (!payments.length) {
        list.innerHTML = '';
        emptyState.classList.remove('d-none');
        return;
    }
    emptyState.classList.add('d-none');

    const statusMap = {
        submitted: { badge: 'bg-warning text-dark', label: 'Pending Verification', icon: 'fa-hourglass-half' },
        verified: { badge: 'bg-success', label: 'Verified', icon: 'fa-check-circle' },
        rejected: { badge: 'bg-danger', label: 'Rejected', icon: 'fa-times-circle' }
    };

    list.innerHTML = payments.map(payment => {
        const status = statusMap[payment.status] || statusMap.submitted;
        const createdAt = payment.created_at ? new Date(payment.created_at).toLocaleString() : 'N/A';
        const verifiedAt = payment.verified_at ? new Date(payment.verified_at).toLocaleString() : null;
        const canVerify = payment.status === 'submitted' && !bill.paid;
        const canReject = payment.status === 'submitted';
        const showButtons = canVerify || canReject;
        return `
            <div class="list-group-item">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
                    <div>
                        <h6 class="mb-1">₹${payment.amount.toFixed(2)} · ${(payment.method || 'upi').toUpperCase()}</h6>
                        <div class="small text-muted">Reference: ${payment.reference || 'N/A'}</div>
                        <div class="small text-muted">Submitted: ${createdAt}${payment.student_name ? ` by ${payment.student_name}` : ''}</div>
                        ${payment.notes ? `<div class="small text-muted">Notes: ${payment.notes}</div>` : ''}
                        ${verifiedAt ? `<div class="small text-muted">Verified: ${verifiedAt} by ${payment.verified_by || 'Admin'}</div>` : ''}
                    </div>
                    <div class="d-flex flex-column align-items-start gap-2">
                        <span class="badge ${status.badge}"><i class="fas ${status.icon} me-1"></i>${status.label}</span>
                        ${showButtons ? `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" ${canVerify ? '' : 'disabled'} onclick="updatePaymentStatus(${payment.id}, 'verify')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" ${canReject ? '' : 'disabled'} onclick="updatePaymentStatus(${payment.id}, 'reject')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function updatePaymentStatus(paymentId, action) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    try {
        const response = await fetch(`/payment/${paymentId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify({ action })
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Failed to update payment');
        }
        showAdminPaymentFeedback(data.message, 'success');
        await loadAdminPayments(activeBillForPayments);
        setTimeout(() => window.location.reload(), 1200);
    } catch (error) {
        showAdminPaymentFeedback(error.message || 'Unable to update payment.', 'danger');
    }
}

function recordOfflinePayment() {
    if (!activeBillForPayments) return;
    if (!confirm('Confirm recording an offline payment and marking the bill as paid?')) return;
    markAsPaid(activeBillForPayments, null, true);
}

// Mark bill as paid
async function markAsPaid(billId, paymentId = null, skipConfirm = false) {
    if (!skipConfirm && !confirm('Are you sure you want to mark this bill as paid?')) return;
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch(`/bill/${billId}/mark-paid`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify({ payment_id: paymentId })
        });
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.message);
        
        // Show success message and reload
        const alert = document.createElement('div');
        alert.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
        alert.style.zIndex = '9999';
        alert.textContent = data.message;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    } catch (error) {
        alert(error.message || 'Failed to update bill status. Please try again.');
    }
}

// Delete bill
async function deleteBill(billId) {
    if (!confirm('Are you sure you want to delete this bill? This action cannot be undone.')) return;
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch(`/bill/${billId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.message);
        
        // Show success message and reload
        const alert = document.createElement('div');
        alert.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
        alert.style.zIndex = '9999';
        alert.textContent = data.message;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            location.reload();
        }, 1000);
    } catch (error) {
        alert(error.message || 'Failed to delete bill. Please try again.');
    }
}

// Print bill
function printBill() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Mess Bill</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .no-print { display: none; }
                        body { padding: 20px; }
                        .table { border: 1px solid #dee2e6; }
                        .table th, .table td { border: 1px solid #dee2e6; }
                    }
                </style>
            </head>
            <body>
                <div class="container py-4">
                    ${document.getElementById('billDetails').innerHTML}
                    <div class="row mt-5">
                        <div class="col-6">
                            <p class="mb-5">_____________________</p>
                            <p class="text-center">Student Signature</p>
                        </div>
                        <div class="col-6 text-end">
                            <p class="mb-5">_____________________</p>
                            <p class="text-center">Authorized Signature</p>
                        </div>
                    </div>
                </div>
                <script>
                    window.print();
                <\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}
</script>
{% endblock %}